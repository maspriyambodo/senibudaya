<?php
	namespace App\Http\Controllers\Cms\Schedule;
	
	use App\Http\Controllers\Cms\AuthController;
	use App\Classes\ClassMenu;
	use App\Models\Parameter;
	use App\Models\Propinsi;
	use App\Models\Kabupaten;
	use App\Models\Jadwal;
	use Illuminate\Http\Request;
	use Illuminate\Http\Client\Pool;
	use Illuminate\Support\Facades\Session;
	use Illuminate\Support\Facades\Http;
	use Carbon\Carbon;
	use DataTables;
	use Image;
	
	class ImsakiyahController extends AuthController
	{
		private $target = 'cms.schedule.imsakiyah';
		
		public function json(){
			$data = Http::asForm()->post(env('APP_API').'apiv1/ajax/getApiimsakiyah', [
			'prov' => request('kategori'),
			'kabko' => request('sub'),
			'thn' => request('year'),
			])->getBody()->getContents();
			$data = str_replace('prov','propinsi',$data);
			$data = str_replace('kabko','kabupaten',$data);
			$data = json_decode($data, false);
			
			$jadwal = array();
			$jadwal['draw'] = 0;
			$jadwal['recordsTotal'] = count((array)$data->data);
			$jadwal['recordsFiltered'] = count((array)$data->data);
			$jadwal['data'] = array();
			foreach ($data->data as $d){
				$d->tanggal = $d->tanggal.' Ramadan '.$data->hijriah.'H';
				$jadwal['data'][] = $d;
			}
			return json_decode(json_encode($jadwal), false);
		}
		
		public function index(){
			$data = array_merge(ClassMenu::view($this->target), array('filter' => array()));
			
			$column = array(
			'id' => 'data',
			'align' => array('center','left','center','center','center','center','center','center','center','center'),
			'data' => array('tanggal', 'imsak', 'subuh', 'terbit', 'dhuha', 'dzuhur', 'ashar', 'maghrib', 'isya'),
			'nosort' => array(0,1,2,3,4,5,6,7,8,9),
			);
			
			//propinsi
			$propinsi = Http::post(env('APP_API').'apiv1/ajax/getApiProv')->getBody()->getContents();
			$propinsi = str_replace('provKode','id',$propinsi);
			$propinsi = str_replace('provNama','name',$propinsi);
			$propinsi = json_decode($propinsi, false);
			
			$id_propinsi = 0;
			foreach ($propinsi as $p){
				if(strtolower(trim($p->name)) == 'dki jakarta')
					$id_propinsi = $p->id;
			}
			
			//kabupaten
			$kabupaten = Http::asForm()->post(env('APP_API').'apiv1/ajax/getApiKabko', [
			'x' => $id_propinsi,
			])->getBody()->getContents();
			$kabupaten = str_replace('kabkoKode','id',$kabupaten);
			$kabupaten = str_replace('kabkoNama','name',$kabupaten);
			$kabupaten = json_decode($kabupaten, false);
			
			//bulan
			for($m = 1; $m<=12; $m++)
				$bulan[$m] = getBulan($m);
			
			//tahun
			$tahun = Http::post(env('APP_API').'apiv1/ajax/getTahunimsak')->getBody()->getContents();
			$tahun = explode("</option><option value='", $tahun);
			$dta = array();
			foreach ($tahun as $val){
				list($tahun, $value) = explode("' >", $val);
				$dta[preg_replace("/[^0-9]/", "",$tahun)] = strip_tags($value);
			}
			$tahun = json_decode(json_encode($dta), false);
			
			$data = array_merge(
				$data, 
				array('column' => $column),
				array('propinsi' => $propinsi),
				array('kabupaten' => $kabupaten),
				array('bulan' => $bulan),
				array('tahun' => $tahun),
			);
			return view($this->target, $data);
		}
		
		public function show(Request $request){
			if($request->id){
				$kabupaten = Http::asForm()->post(env('APP_API').'apiv1/ajax/getApiKabko', [
				'x' => $request->id,
				])->getBody()->getContents();
				$kabupaten = str_replace('kabkoKode','id',$kabupaten);
				$kabupaten = str_replace('kabkoNama','name',$kabupaten);
				return json_encode(json_decode($kabupaten, false));
			}
		}
	}
